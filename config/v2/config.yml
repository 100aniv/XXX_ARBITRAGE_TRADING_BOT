# V2 Runtime Config SSOT
# ========================
# 목적: 하드코딩/스크립트 파라미터 난립 차단
# 규칙: Secrets(API Key)는 절대 여기 넣지 말고 .env.v2로만
# 검증: arbitrage.v2.core.config.load_config()로 validation

# Execution Environment (SSOT - D206 Taxonomy)
# BACKTEST: 과거 데이터 재생 (historical replay)
# PAPER: 실시간 데이터 + 모의 체결 (live data, simulated fills)
# LIVE: 실시간 데이터 + 실제 체결 (live data, real fills)
execution:
  environment: "paper"  # backtest | paper | live
  
  # Run Profile (실행 프로파일 - 시간/검증 강도)
  # SMOKE: 5분 이내 (빠른 검증)
  # BASELINE: 20분 (표준 검증)
  # LONGRUN: 60분+ (장기 실증)
  # ACCEPTANCE: 80분+ (Paper Acceptance)
  # EXTENDED: 3시간+ (확장 검증)
  profile: "smoke"  # smoke | baseline | longrun | acceptance | extended
  
  # Validation Rigor (검증 엄격도)
  # QUICK: 빠른 검증 (슬리피지/latency 모델 옵션)
  # SSOT: 운영급 검증 (WARN=FAIL, 슬리피지/latency 강제, DB strict)
  rigor: "quick"  # quick | ssot
  cycle_interval_seconds: 2.0

# Legacy (Deprecated, use execution.environment)
mode: "paper"  # paper, live, replay

# FX 설정 (D205-15-4: Real-time FX Integration)
fx:
  # Provider 선택: "fixed" (테스트/Paper용) | "live" (실시간)
  provider: "live"
  
  # Fixed FX 설정 (provider="fixed"일 때만)
  fixed:
    krw_per_usdt: 1450.0  # 고정 환율 (테스트용)
  
  # Live FX 설정 (provider="live"일 때만)
  live:
    # 소스: "crypto_implied" (Upbit BTC/KRW ÷ Binance BTC/USDT) | "http" (외부 API)
    source: "crypto_implied"
    
    # 캐시 TTL (초)
    ttl_seconds: 10
    
    # HTTP 소스 설정 (source="http"일 때만, 선택)
    http:
      base_url: ""  # 외부 FX API URL (선택)
      timeout_seconds: 5
      retry_count: 3
  
  # LIVE 모드 안전장치
  # LIVE 모드에서 fixed provider 사용 시 부팅 차단 (1300원 참사 방지)
  live_mode_requires_live_fx: true

# 거래소 설정
exchanges:
  upbit:
    name: "upbit"
    enabled: true
    
    # 수수료 (%)
    taker_fee_bps: 5.0  # 0.05%
    maker_fee_bps: 5.0  # 0.05%
    
    # 최소 주문 금액 (KRW)
    min_order_krw: 5000
    
    # MARKET 주문 규약
    market_order_rules:
      buy_uses: "quote_amount"   # MARKET BUY는 KRW 금액
      sell_uses: "base_qty"      # MARKET SELL은 코인 수량
    
    # Rate Limit (미구현, 참조용)
    rate_limit:
      orders_per_second: 8
      requests_per_second: 30
  
  binance:
    name: "binance"
    enabled: true
    
    # 수수료 (%)
    taker_fee_bps: 4.0  # 0.04%
    maker_fee_bps: 4.0  # 0.04%
    
    # 최소 주문 금액 (USDT)
    min_notional_usdt: 10.0
    
    # MARKET 주문 규약
    market_order_rules:
      buy_uses: "quantity"   # MARKET BUY는 수량
      sell_uses: "quantity"  # MARKET SELL도 수량
    
    # Rate Limit (미구현, 참조용)
    rate_limit:
      orders_per_second: 10
      requests_per_second: 50

# Universe (거래 대상) - D205-15-2
universe:
  # Mode: "static" | "topn"
  mode: "static"  # D205-15-2: static (고정 리스트) or topn (동적 Top N)
  
  # TopN 설정 (mode="topn"일 때만 사용)
  topn_count: 20
  data_source: "mock"  # "mock" | "real"
  cache_ttl_seconds: 600
  min_volume_usd: 1000000.0
  min_liquidity_usd: 50000.0
  max_spread_bps: 50.0
  
  # Static 심볼 리스트 (mode="static"일 때만 사용)
  static_symbols:
    - ["BTC/KRW", "BTC/USDT"]
    - ["ETH/KRW", "ETH/USDT"]
    - ["XRP/KRW", "XRP/USDT"]
    - ["SOL/KRW", "SOL/USDT"]
    - ["DOGE/KRW", "DOGE/USDT"]
    - ["ADA/KRW", "ADA/USDT"]
    - ["AVAX/KRW", "AVAX/USDT"]
    - ["DOT/KRW", "DOT/USDT"]
    - ["MATIC/KRW", "MATIC/USDT"]
    - ["LINK/KRW", "LINK/USDT"]
    - ["ATOM/KRW", "ATOM/USDT"]
    - ["ETC/KRW", "ETC/USDT"]
  
  # Legacy (Deprecated, use universe.mode instead)
  symbols_top_n: 20
  allowlist: []
  denylist:
    - "DOGE/KRW"
    - "SHIB/KRW"
    - "MATIC/KRW"

# Strategy (전략 파라미터)
strategy:
  # Edge Guard (D207-1-1: Economic Truth)
  min_net_edge_bps: 2.0  # TURN6: partial fill trade net_edge 평균(0.0) + 2.0bps
  deterministic_drift_bps: 10.0  # D207-3: 탐지 단계 고정 드리프트 패널티
  negative_edge_execution_probability: 0.15  # D_ALPHA-1U-FIX-2-1: 음수 edge 일부 허용 확률
  negative_edge_floor_bps: -10.0  # D_ALPHA-1U-FIX-2-1: 허용 음수 edge 하한

  # OBI Filter (D_ALPHA-2)
  obi_filter:
    enabled: true
    levels: 5
    threshold: 0.02
    top_k: 0

  # OBI Dynamic Threshold (D_ALPHA-2)
  obi_dynamic_threshold:
    enabled: true
    warmup_sec: 180
    percentile: 0.9
    min_pass_rate: 0.05
    min_samples: 50

  # Maker Fill Probability (D_ALPHA-1)
  fill_probability:
    base_fill_probability: 0.7
    queue_position_penalty: 0.1
    volatility_penalty: 0.05
    min_fill_probability: 0.3
    max_fill_probability: 0.95
    wait_time_seconds: 5.0
    slippage_per_second_bps: 0.2
  
  # Break-even 계산식 (D205-15-6: Config SSOT)
  # break_even_bps = fee_entry + fee_exit + execution_risk_round_trip + buffer
  # execution_risk_round_trip = (slippage + latency) * 2
  break_even:
    # 수수료 (거래소 설정에서 자동 로드)
    use_exchange_fees: true
    
    # Execution Risk: Slippage (%)
    slippage_bps: 15.0  # 0.15% (D205-15-5d: 기본값)
    
    # Execution Risk: Latency (%)
    latency_bps: 10.0   # 0.10% (D205-15-6: 신규 추가)
    
    # Buffer (안전 마진, %)
    buffer_bps: 0.0     # 0.00% (D205-15-6: 기본값 0, CLI override 가능)
  
  # Deprecated: 하위 호환용 (break_even으로 이관됨)
  threshold:
    use_exchange_fees: true
    slippage_bps: 5.0
    buffer_bps: 10.0
  
  # Order Size Policy (주문 크기 결정)
  order_size_policy:
    # "fixed_quote": 고정 금액 (KRW/USDT)
    # "risk_based": 리스크 기반 (max_position * risk_factor)
    mode: "fixed_quote"
    
    # Fixed Quote 설정
    fixed_quote:
      upbit_krw: 5000     # 업비트 고정 주문 금액
      binance_usdt: 10.0  # 바이낸스 고정 주문 금액

# Engine cycle interval (seconds)
cycle_interval_seconds: 2.0

# 동시 실행 가능 주문 수
max_concurrent_orders: 1

# Dry-run 모드 (실제 주문 없이 로그만)
dry_run: true

# MockAdapter 설정 (테스트 전용, D205-18-1)
mock_adapter:
  # 슬리피지 활성화 여부
  enable_slippage: true
  
  # 슬리피지 범위 (bps)
  # D205-17: Net edge 77bps 기준, 20-50bps (25-65% of edge)
  slippage_bps_min: 20.0
  slippage_bps_max: 50.0

  # Pessimistic drift 범위 (bps)
  # D207-3: Physical price contamination guard
  pessimistic_drift_bps_min: 10.0
  pessimistic_drift_bps_max: 10.0
  adverse_slippage_probability: 0.15
  adverse_slippage_bps_min: 10.0
  adverse_slippage_bps_max: 25.0
  fill_reject_probability: 0.05
  max_safe_ratio: 0.3
  paper_deterministic: true
  random_seed: 20260204

# Safety (안전 장치)
safety:
  # 일일 최대 손실 (KRW)
  max_daily_loss_krw: 100000  # 10만원
  
  # 최대 포지션 크기 (USD 기준)
  max_position_usd: 1000.0
  
  # Min Hold (최소 보유 시간, ms)
  min_hold_ms: 1000
  
  # Cooldown (연속 손실 후 대기 시간, 초)
  cooldown_after_loss_seconds: 30  # 30초
  
  # Emergency stop (즉시 중단 조건)
  emergency_stop:
    enabled: true
    max_consecutive_losses: 3  # 연속 손실 3회 시 중단

# Reporting (리포팅 설정)
reporting:
  # PnL 집계 윈도우
  pnl_windows:
    - "daily"
    - "weekly"
    - "monthly"
  
  # Snapshot 저장 경로
  snapshot_path: "logs/evidence"
  
  # 리포트 생성 주기 (초, 0이면 비활성화)
  report_interval_seconds: 3600  # 1시간마다

# Monitoring (모니터링 설정)
monitoring:
  # Prometheus exporter 활성화
  prometheus_enabled: false
  
  # Metrics 엔드포인트
  metrics_endpoint: "0.0.0.0:9100"
  
  # Health check 주기 (초)
  health_check_interval_seconds: 30

# Logging (로깅 설정)
logging:
  # 로그 레벨 (DEBUG, INFO, WARNING, ERROR)
  level: "INFO"
  
  # 로그 파일 경로
  file_path: "logs/v2_engine.log"
  
  # 로그 rotation
  rotation:
    max_bytes: 10485760  # 10MB
    backup_count: 5

# Database (DB 설정, 미구현 시 null)
database:
  enabled: false
  # 추후 구현 시:
  # host: "localhost"
  # port: 5432
  # name: "arbitrage"
  # 주의: user/password는 .env.v2에서만

# Cache (캐시 설정)
cache:
  # Redis 사용 여부
  redis_enabled: false
  
  # Market data cache TTL (밀리초)
  market_data_ttl_ms: 100

# Tuning (파라미터 자동 튜닝 설정 - D205-14)
tuning:
  # 튜닝 활성화 여부
  enabled: false
  
  # 주문 금액 (KRW) - D205-14-6
  notional: 500000
  
  # 파라미터 범위 (Grid Search용)
  param_ranges:
    # Slippage Alpha (ExecutionQuality)
    slippage_alpha: [5.0, 10.0, 15.0, 20.0]
    
    # Partial Fill Penalty (bps)
    partial_fill_penalty_bps: [10.0, 20.0, 30.0]
    
    # Max Safe Ratio (0.0 ~ 1.0)
    max_safe_ratio: [0.2, 0.3, 0.4]
    
    # Min Spread (bps)
    min_spread_bps: 20.0
  
  # Sweep 설정
  sweep:
    method: "grid"  # grid, random, bayesian
    max_iterations: 100

  # Objective 설정
  objective:
    metric: "positive_net_edge_rate"  # 목표 지표
    direction: "maximize"  # maximize, minimize

# Profit Core (하드코딩 제거)
profit_core:
  # 기본 가격 (Mock/Fallback용)
  default_price_krw: 80000000.0  # 80M KRW (BTC 기준)
  default_price_usdt: 60000.0     # 60K USDT (BTC 기준)

  # 가격 sanity check 범위
  price_sanity_min_krw: 40000000.0   # 40M KRW
  price_sanity_max_krw: 200000000.0  # 200M KRW

  # Sanity check 활성화
  enable_sanity_check: true

# Tuner Interface (튜너 훅)
tuner:
  # 튜너 활성화 여부
  enabled: false

  # 튜너 타입: "static" (config 기반) | "grid" (Grid Search) | "bayesian" (Bayesian Optimization)
  tuner_type: "static"

  # 파라미터 오버라이드 (static 튜너 전용)
  # 예: buffer_bps를 15.0으로 고정
  param_overrides:
    # buffer_bps: 15.0
    # slippage_bps: 20.0

# Meta (메타 정보)
meta:
  version: "v2.2.0"
  config_name: "v2_baseline_d206_1"
  created_at: "2026-01-15"
  description: "V2 SSOT Config - D206-1 Profit Core + Tuner Interface"
