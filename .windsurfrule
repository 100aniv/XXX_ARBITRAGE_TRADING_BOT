# .windsurfrules — XXX_ARBITRAGE_TRADING_BOT (ARBITRAGE-LITE) SSOT RULEBOOK
# 목적: “한 턴 끝장” 실행 품질을 SSOT로 강제. 스킵/선택/대충/DEFER 금지.
# 원칙: 완료 전에는 다음 D로 못 넘어간다. 테스트 100% PASS가 아닌 한 Done 아님.

---

## [BOOTSTRAP] 부트스트랩 강제 규칙 (모든 작업 시작 시 필수)

**매 D 작업 시작 시 아래 4개 SSOT 문서를 반드시 먼저 열고 확인:**

1. **docs/v2/SSOT_RULES.md** (개발 규칙 SSOT)
   - 경로: docs/v2/SSOT_RULES.md
   - 역할: V2 강제 규칙, 금지 사항, 경로 규칙
   - 확인: 현재 작업이 금지 사항과 충돌하는지 체크

2. **docs/v2/V2_ARCHITECTURE.md** (아키텍처 계약 SSOT)
   - 경로: docs/v2/V2_ARCHITECTURE.md
   - 역할: Engine-Centric 설계, OrderIntent 규약, Adapter 패턴
   - 확인: 구현 방향이 아키텍처와 일치하는지 체크

3. **D_ROADMAP.md** (프로세스 SSOT)
   - 경로: D_ROADMAP.md (루트, docs/ 아님)
   - 역할: 전체 로드맵, D 번호 정의, AC/증거 경로
   - 확인: 현재 D와 다음 D가 로드맵과 일치하는지 체크

4. **docs/v2/design/SSOT_MAP.md** (SSOT 맵 SSOT)
   - 경로: docs/v2/design/SSOT_MAP.md
   - 역할: 도메인별 SSOT 위치, 중복 금지 규칙
   - 확인: 신규 파일/설정이 SSOT_MAP의 도메인과 일치하는지 체크

**충돌 발견 시 절차:**
1. 문서 4개의 불일치 부분을 특정
2. 코드 작업 금지 (문서 정합 우선)
3. 불일치 수정 → Gate 검증 → 커밋 후에만 다음 단계 진행

**주의:**
- .windsurfrule은 링크/순서 강제만 함 (SSOT 정의 복붙 금지)
- 각 SSOT의 상세 정의는 해당 문서에서만 관리
- 변경 시 "4개 문서 간 일관성" 검증 필수

---

## [WATCHDOG] 게이트 4종세트 운용 규칙

**테스트는 watchdog/just 기반 4종세트(doctor/fast/regression/full)로 수행:**

1. **just doctor** - Syntax/Import 검사 (빠름, ~5초)
   - 명령: `just doctor`
   - 목적: 코드 수집 가능 여부만 확인
   - 실패 시: 즉시 중단, 구문 오류 수정

2. **just fast** - 핵심 테스트 (빠름, ~10초)
   - 명령: `just fast`
   - 목적: 코어 로직 검증 (ML/Live/API 제외)
   - 실패 시: 즉시 중단, 원인 수정

3. **just regression** - 전체 테스트 (중간, ~1분)
   - 명령: `just regression`
   - 목적: 베이스라인 회귀 검증 (Live API 제외)
   - 실패 시: 즉시 중단, 회귀 원인 분석

4. **just full** (선택) - 전체 테스트 (느림, ~5분+)
   - 명령: `just full` (미구현 시 생략)
   - 목적: Live API 포함 전체 검증
   - 실패 시: 즉시 중단, 환경 재확인

**자세한 정책/명령은 아래 문서 링크로만 참조 (복붙 금지):**
- GATE 정책: `docs/v2/SSOT_RULES.md` (검증 규칙)
- Evidence 포맷: `docs/v2/design/EVIDENCE_FORMAT.md` (증거 저장 규칙)

**주의:**
- [BOOTSTRAP]과 충돌 없게 정리 (부트스트랩 먼저, 게이트 나중)
- Evidence는 자동 생성 (logs/evidence/<run_id>/)
- FAIL 시 우회 금지 (원인 확정 → 수정 → 재실행)

---

## 0) 절대 규칙 (Non-Negotiable)
- (SSOT) D 번호 체계만 사용. PHASE 표기 혼용 금지. 다음 단계 번호는 D_ROADMAP에 있는 것만 사용(임의로 늘리지 말 것).
- (무스킵) "시간 오래걸리니 스킵" 금지. “선택적/DEFERRED” 표기 금지(승인 없는 미룸 금지).
- (완전성) Regression 실패/Flaky/Hang/Timeout 하나라도 남으면 “단계 진행” 금지. 원인 확정 → 수정 → 재실행 → 증거 저장까지 완료해야 Done.
- (중복금지) 작업 시작 시 항상 레포 루트 스캔으로 기존 모듈 재사용. 오버리팩토링/중복 구현 금지.
- (No Side-track) 현재 D의 목표/AC와 무관한 변경 금지. 단, “기존 테스트 FAIL/행/프로덕션 설정 오류”는 예외 없이 FIX 대상(빚은 갚고 간다).
- (언어) 문서/커밋 메시지/리포트는 한국어 기본(필요한 용어만 영문 괄호 병기).
- (증거) 모든 실행은 evidence 폴더에 로그/요약/메트릭/쿼리 스냅샷을 남겨야 한다.

---

## 1) ONE-TURN ENDGAME 표준 템플릿 (Windsurf는 항상 이 구조로 수행)
아래 STEP을 “순서대로” 수행하고, 중간에 멈추지 말 것.
각 STEP 종료 시: ✅조건 충족 여부 + evidence 경로 + 핵심 결과(숫자)를 짧게 기록.

### STEP 0) 실행 환경 정리 (필수)
- venv 활성화 확인
- 중복 python 프로세스 탐지/종료
  - 장기 실행 모드의 “런처+워커 2개 패턴”은 정상으로 간주(규칙대로 모니터링)
- Docker 컨테이너 상태 확인(필수: Redis/Postgres, 필요 시 Prometheus/Grafana)
- 상태 초기화(필수):
  - Redis FLUSHALL
  - Postgres 초기화(프로젝트 SSOT 스크립트/명령 우선 사용)
- 새 CMD 창에서 실행(로그 섞임 방지)

✅ STEP0 Done 조건:
- python 프로세스 정리 완료 / Docker 정상 / Redis+DB 초기화 완료 / evidence에 캡처 저장

### STEP 1) 컨텍스트/SSOT 로드 + 레포 루트 스캔 (필수)
- CHECKPOINT 문서를 “미완 항목이 0이 될 때까지” 상시 참조
- D_ROADMAP에서 “현재 D”와 “다음 D”를 확정 (임의 추가 금지)
- 레포 스캔 키워드:
  - infra: docker, redis, postgres, prometheus, grafana
  - trading: websocket, async, rate limit, orderbook, fill model
  - tuning: optuna, tuning, jobs, worker, runner
  - observability: metrics, exporter, alerting, telegram
- 기존 모듈/스크립트 재사용 가능 여부를 표로 정리(짧게라도).

✅ STEP1 Done 조건:
- “이번 턴의 목표/AC/수정 범위”가 문서/로드맵 기반으로 고정됨
- 불필요한 작업(사이드트랙) 0개

### STEP 2) Plan (필수)
- 이번 턴에서 끝낼 “정확한 변경 목록(파일/함수 단위)” 작성
- 실패 시 롤백/재실행 기준을 먼저 선언
- Hang 감지/대응 기준을 먼저 선언(아래 4번 규칙 준수)

✅ STEP2 Done 조건:
- 작업 범위/AC/테스트 계획/모니터링 계획이 구체적임(추상 금지)

### STEP 3) 구현 (필수)
- 최소 변경 원칙: 필요한 최소 범위만 수정
- 공용부 수정 시 영향 범위를 명확히(왜 필요한지)
- 로그/메트릭/알림 훅은 “운영 관점”에서 누락 없이

✅ STEP3 Done 조건:
- 구현 완료 + 로컬에서 재현 가능한 실행 커맨드 확보

### STEP 4) 테스트 & 모니터링 (강제: 3-Gate)
#### Gate A) Fast Gate (30~90초 목표, FAIL 즉시 중단/수정)
- compileall / import sanity / 핵심 유닛(변경 모듈만)
- 가능한 SSOT 명령이 있으면 그걸 사용

#### Gate B) Core Regression (2~6분 목표, SSOT 타깃 100% PASS 강제)
- 프로젝트에 이미 “항상 돌리던” 회귀 타깃이 있으면 그게 SSOT
- 없으면 “tests/” 기반으로 합리적 SSOT 타깃을 문서화해서 고정(다음 턴부터 동일 명령 강제)

#### Gate C) Full Suite (필요 시)
- 변경 범위가 크거나 최근 불안정이면 수행(“필요 시” 판단은 증거 기반)

✅ STEP4 Done 조건:
- 목표 Gate가 100% PASS
- Hang/Flaky 의심이 있으면 원인 확정 후 제거(아래 4번 룰)

### STEP 5) 문서/ROADMAP/CHECKPOINT 동기화 (필수)
- D_REPORT(또는 해당 D 문서)에:
  - 목표/변경점/테스트 결과/증거 경로/남은 GAP=0
- D_ROADMAP:
  - 완료 체크 ✅, 다음 단계 정의(로드맵과 불일치 금지)
- CHECKPOINT:
  - 관련 섹션 “미완=0”이 될 때까지 갱신

✅ STEP5 Done 조건:
- 문서 3종(D_REPORT/D_ROADMAP/CHECKPOINT) 일관성 100%

### STEP 6) Git Commit + Push (필수, 대용량 제외)
- git status / git diff --stat 출력 저장(evidence)
- 의미 있는 커밋 메시지(한국어)
- push 성공
- 최종 산출물로:
  1) compare/PR URL
  2) 큰 파일 raw.githubusercontent.com 링크
  3) “이 URL 기준으로 검증/판정” 문구 포함

✅ STEP6 Done 조건:
- 로컬/원격 동기화 완료 + 링크 기반 검증 가능

---

## 2) “테스트 모니터링 / HANG 감지” 강제 규칙 (가장 중요)
### A) 명령 실행 모니터링 기본
- 10초 이상 걸리는 모든 명령은 “로그 파일로 리다이렉션”하고 tail 관측
- 관측 주기: 30초 (짧은 테스트) / 60초 (긴 테스트)
- “출력 없음 + 로그 라인 수 증가 없음”이 연속 120초면 HANG 의심
- HANG 의심 시 절차:
  1) 즉시 중단(CTRL+C) 시도
  2) 프로세스/자식 프로세스 확인 후 강제 종료
  3) 마지막 실행 테스트/케이스/단계 특정
  4) 원인 확정(락/네트워크/무한루프/대기) 후 수정
  5) 동일 커맨드로 재현 → 해결 확인 → 전체 회귀 재실행

### B) pytest 타임아웃 강제(권장: pytest-timeout)
- pytest-timeout을 dev 의존성으로 포함하고,
  - 기본 타임아웃(예: 60s~180s)을 ini 또는 CLI로 강제
  - Windows 호환을 고려해 timeout-method를 thread로 고정하는 편이 안전
  (pytest-timeout은 테스트가 무한정 멈추는 문제를 실전에서 제일 잘 잡아준다.)  :contentReference[oaicite:2]{index=2}
- 빠른 실패를 위해 -x/--maxfail 사용 가능(단, 최종 판정은 전체 100% PASS로만 인정) 

### C) “대기”의 정의
- “원래 오래 걸리는 테스트”는 허용.
- 하지만 “진행률/로그 변화/CPU I/O 움직임”이 없으면 오래 걸리는 게 아니라 ‘멈춘 것’.
- 멈춘 건 버그다. 기다리면 해결 안 된다. 원인 찾아서 고친다.

---

## 3) 인프라/DB/Redis 관련 강제 규칙
- DB/Redis 사용하는 단계는 반드시 Docker 기반 서비스가 살아있는 상태에서 수행
- DB 꺼졌다고 기능 비활성화/파일 저장으로 우회 금지
- 실행 전/후로 상태를 깨끗하게(쿨다운/포트폴리오/가드/키 prefix 오염 금지)
- 실행 중 중복 프로세스 발견 시 즉시 중단 후 정리 → 재실행

---

## 4) “장기 PAPER / LIVE 전” 우선순위 원칙 (산으로 가는 걸 막기 위한 규칙)
- UI(대시보드)는 “장기 PAPER 안정성 검증”을 돕기 위한 도구일 뿐, 본질이 아님.
- 다음 우선순위를 강제:
  1) 20분 스모크 → 1시간 베이스라인 → 3~12시간 롱런 PAPER (계단식 검증)
  2) 그 결과로 PnL/스프레드/라우팅/실패율/레이트리밋을 수치로 확정
  3) 그 다음에 튜닝(아비트라지 특화 튜닝 포함)
  4) 그 다음에 LIVE 점진 확대
- “TopN 멀티심볼이 Top100까지 완료인지” 같은 범위 질문은 D_ROADMAP/SSOT로 확인 후 문서에 명시(추측 금지).

---

## 5) 결과 리포팅(상용급)
- 장기 실행 결과는 사용자에게 “요약 KPI + 근거 증거 링크”로 보여줘야 함
- 최소 포함:
  - 실행 구간(시간), 심볼 수, 라운드트립 수, 성공률, PnL(총/일간화), 스프레드 분포, 실패/재시도/429 비율
  - 알림 발생 카운트(P0~P3)
  - evidence 폴더 링크/경로

---

## 6) 출력 형식(최종 응답 강제)
- DONE 시 반드시 아래를 포함:
  - (1) What/Why/How 요약(3~7줄)
  - (2) 테스트 결과(숫자) + 실행 커맨드
  - (3) evidence 경로
  - (4) Git commit hash / compare(또는 PR) URL / 큰 파일 raw 링크
- FAIL 시 반드시 아래를 포함:
  - (1) 실패 원인(재현 커맨드)
  - (2) 어디서 hang/FAIL 났는지(마지막 로그 위치)
  - (3) 수정안 + 재실행 결과(증거)

# .windsurfrule (SSOT)
# Scope: XXX_ARBITRAGE_TRADING_BOT / arbitrage-lite
# Language: 한국어(필요한 기술용어만 영문 병기)

## 0) 역할 분리 (강제)
- Windsurf: 코드 작성/수정 + 테스트 실행 + 증거 저장 + 문서 업데이트 + 커밋/푸시
- GPT: 결과 로그 기반 PASS/FAIL 판정 + 다음 프롬프트 생성
- “사용자에게 실행 떠넘기기/검증 떠넘기기” 금지

## 1) 절대 워크플로우 (강제)
Plan → 구현 → 테스트/모니터링 → 자동 디버깅 → 재실행 → 문서/ROADMAP 업데이트 → Git Commit → Push
- 중간 스킵 금지
- “DEFERRED / 예상된 실패 / 시간 관계상” 금지

## 2) 사전 스캔 (중복/오버리팩토링 방지)
- 작업 시작 시 반드시 repo 루트 스캔:
  - 기존 모듈/유틸/테스트/SSOT 스크립트 재사용
  - 중복 파일/중복 기능 생성 금지

## 3) 테스트 계층 3단 (SSOT)
- Fast Gate (30~90초):
  - 변경 모듈 관련 최소 타깃 pytest
  - FAIL 즉시 중단→수정→재실행
- Core Regression (2~6분):
  - 프로젝트 SSOT로 정의된 고정 타깃 100% PASS
- Full Suite:
  - 범위가 크거나 불안정/릴리즈 전이면 반드시 수행
  - HANG/무출력은 “FAIL”이며 원인 규명+차단(타임아웃+스택덤프)까지 완료해야 다음 단계 진행

## 4) HANG/무출력 대응 규칙
- “기다리면 끝날지도” 금지
- 타임아웃/스택덤프/마지막 테스트명 확보가 SSOT
- 원인 특정은 부분 실행/이진탐색으로 확정
- 해결 후 동일 명령으로 재현 불가(=PASS) 증명

## 5) 인프라/프로세스 청결(오염 방지)
- 실행 전:
  - 중복 python 프로세스 kill
  - Docker(Redis/Postgres/Prometheus/Grafana) 상태 확인
  - 테스트/실행 오염 가능하면 Redis/DB 초기화(프로젝트 정책 준수)
- 장시간 실행은 새 CMD 창에서 독립 실행
- Windows 환경에서 런처+워커 2개 python 프로세스는 정상 패턴(불필요 질문 금지)

## 6) 모니터링/증거(Evidence) 규칙
- 모든 Gate/중요 실행은 증거 파일로 저장:
  - docs/<D번호>/evidence/<task_id_yyyymmdd_hhmm>/
  - env.txt, tests.txt, cmd.txt, trace.txt, kpi.json 등
- “증거 없는 PASS 선언” 금지

## 7) 문서/로드맵/체크포인트 SSOT 규칙
- D_ROADMAP.md, CHECKPOINT 문서, 각 D_REPORT의 상태는 1:1로 일치해야 함
- 새 체크포인트 파일 생성 금지(기존 CHECKPOINT에 누적)
- 중복 파일은 병합 후 삭제

## 8) Git 규칙
- 항상 마지막에:
  - git status / git diff --stat
  - 커밋(의미 있는 한국어 메시지)
  - push (대용량/불필요 파일 제외)
- 결과물에 Compare URL 포함

## 9) 프롬프트 출력 템플릿 (Windsurf는 항상 이 형식을 따른다)
[MODEL]
[PRE-READ]
[TASK TITLE]
[GOAL 5줄 선언]
[STEP 0..N: 증거 포함]
[DELIVERABLE 강제 5종]
