# D16 Live Arbitrage Core Architecture

## ğŸ“‹ ê°œìš”

D16ì€ D15 ê³ ì„±ëŠ¥ ëª¨ë“ˆ ìœ„ì— **ì‹¤ê±°ë˜ ê¸°ëŠ¥ì„ ì¶”ê°€**í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.

**í•µì‹¬ ëª©í‘œ:**
- Upbit/Binance ì‹¤ê±°ë˜ ë£¨í”„ êµ¬ì¶•
- D15 ëª¨ë“ˆ (ë³€ë™ì„±, í¬íŠ¸í´ë¦¬ì˜¤, ë¦¬ìŠ¤í¬) ìë™ ì—°ë™
- ì•ˆì „ ì¥ì¹˜ (LiveGuard) í†µí•©
- ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬ (Redis)
- FastAPI ë°±ì—”ë“œ ì œê³µ

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    D16 Live Arbitrage Core                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LivePriceCollector (data/live_prices.py)               â”‚   â”‚
â”‚  â”‚  - Upbit WebSocket (KRW-BTC, KRW-ETH, ...)             â”‚   â”‚
â”‚  â”‚  - Binance WebSocket (BTCUSDT, ETHUSDT, ...)           â”‚   â”‚
â”‚  â”‚  - ìŠ¤í”„ë ˆë“œ ê³„ì‚° (bid-ask)                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²                                                         â”‚
â”‚         â”‚ (ì‹¤ì‹œê°„ ê°€ê²©)                                          â”‚
â”‚         â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LiveTrader (arbitrage/live_trader.py)                 â”‚   â”‚
â”‚  â”‚  - ì°¨ìµ ì‹ í˜¸ ìƒì„±                                       â”‚   â”‚
â”‚  â”‚  - D15 ëª¨ë“ˆ ì—°ë™:                                       â”‚   â”‚
â”‚  â”‚    - VolatilityPredictor (í¬ì§€ì…˜ í¬ê¸°)                 â”‚   â”‚
â”‚  â”‚    - PortfolioOptimizer (ë…¸ì¶œë„ ì¡°ì ˆ)                  â”‚   â”‚
â”‚  â”‚    - QuantitativeRiskManager (ì†ì‹¤ ì œí•œ)              â”‚   â”‚
â”‚  â”‚  - ì£¼ë¬¸ ì‹¤í–‰ (Upbit/Binance)                           â”‚   â”‚
â”‚  â”‚  - í¬ì§€ì…˜ ê´€ë¦¬                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²                                                         â”‚
â”‚         â”‚ (ìƒíƒœ ì €ì¥)                                            â”‚
â”‚         â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  StateManager (arbitrage/state_manager.py)             â”‚   â”‚
â”‚  â”‚  - Redis ê¸°ë°˜ ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬                         â”‚   â”‚
â”‚  â”‚  - ê°€ê²©, ì‹ í˜¸, ì£¼ë¬¸, í¬ì§€ì…˜, ì‹¤í–‰ ê²°ê³¼ ì €ì¥           â”‚   â”‚
â”‚  â”‚  - ë©”íŠ¸ë¦­ ì €ì¥/ì¡°íšŒ                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²                                                         â”‚
â”‚         â”‚ (ìƒíƒœ ì¡°íšŒ)                                            â”‚
â”‚         â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Server (api/server.py)                        â”‚   â”‚
â”‚  â”‚  - /health: í—¬ìŠ¤ ì²´í¬                                  â”‚   â”‚
â”‚  â”‚  - /metrics/live: ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­                        â”‚   â”‚
â”‚  â”‚  - /positions: í¬ì§€ì…˜ ì¡°íšŒ                             â”‚   â”‚
â”‚  â”‚  - /signals: ì‹ í˜¸ ì¡°íšŒ                                 â”‚   â”‚
â”‚  â”‚  - /orders: ì£¼ë¬¸ ì¡°íšŒ                                  â”‚   â”‚
â”‚  â”‚  - /executions: ì‹¤í–‰ ê²°ê³¼ ì¡°íšŒ                         â”‚   â”‚
â”‚  â”‚  - WebSocket: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²                                                         â”‚
â”‚         â”‚ (HTTP/WebSocket)                                       â”‚
â”‚         â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Dashboard (ëŒ€ì‹œë³´ë“œ)                                  â”‚   â”‚
â”‚  â”‚  - ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ì‹œê°í™”                                â”‚   â”‚
â”‚  â”‚  - í¬ì§€ì…˜ ëª¨ë‹ˆí„°ë§                                     â”‚   â”‚
â”‚  â”‚  - ì‹ í˜¸/ì‹¤í–‰ ë¡œê·¸                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SafetyModule (liveguard/safety.py)                    â”‚   â”‚
â”‚  â”‚  - í¬ì§€ì…˜ í¬ê¸° ì œí•œ                                    â”‚   â”‚
â”‚  â”‚  - ì¼ì¼/ëˆ„ì  ì†ì‹¤ ì œí•œ                                 â”‚   â”‚
â”‚  â”‚  - ê±°ë˜ ë¹ˆë„ ì œí•œ                                      â”‚   â”‚
â”‚  â”‚  - ìŠ¬ë¦¬í”¼ì§€ ê²€ì‚¬                                       â”‚   â”‚
â”‚  â”‚  - íšŒë¡œì°¨ë‹¨ê¸°                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Exchange Adapters (arbitrage/exchange/)               â”‚   â”‚
â”‚  â”‚  - UpbitExchange (REST + WebSocket)                    â”‚   â”‚
â”‚  â”‚  - BinanceExchange (REST + WebSocket)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
arbitrage/
    types.py                    # ê³µí†µ íƒ€ì… ì •ì˜
    live_trader.py              # ì‹¤ê±°ë˜ ë£¨í”„
    state_manager.py            # Redis ìƒíƒœ ê´€ë¦¬
    exchange/
        __init__.py
        upbit.py                # Upbit ì–´ëŒ‘í„°
        binance.py              # Binance ì–´ëŒ‘í„°

data/
    live_prices.py              # ì‹¤ì‹œê°„ ê°€ê²© ìˆ˜ì§‘

liveguard/
    __init__.py
    safety.py                   # ì•ˆì „ ì¥ì¹˜
    risk_limits.py              # ë¦¬ìŠ¤í¬ ì œí•œ

api/
    __init__.py
    server.py                   # FastAPI ë°±ì—”ë“œ

tests/
    test_d16_types.py
    test_d16_safety.py
    test_d16_state_manager.py
    test_d16_exchange.py
```

---

## ğŸ”„ ì‹¤ê±°ë˜ ë£¨í”„ íë¦„

```
1. ê°€ê²© ìˆ˜ì§‘
   â”œâ”€ Upbit WebSocket êµ¬ë… (KRW-BTC, KRW-ETH, ...)
   â”œâ”€ Binance WebSocket êµ¬ë… (BTCUSDT, ETHUSDT, ...)
   â””â”€ ì‹¤ì‹œê°„ ê°€ê²© ìºì‹±

2. ì‹ í˜¸ ìƒì„±
   â”œâ”€ ìŠ¤í”„ë ˆë“œ ê³„ì‚° (sell_bid - buy_ask)
   â”œâ”€ ìˆ˜ìµì„± ê²€ì‚¬ (spread_pct > min_spread_pct)
   â””â”€ ì‹ í˜¸ ì €ì¥ (Redis)

3. ì•ˆì „ ê²€ì‚¬
   â”œâ”€ í¬ì§€ì…˜ í¬ê¸° ì œí•œ
   â”œâ”€ ì¼ì¼ ì†ì‹¤ ì œí•œ
   â”œâ”€ ê±°ë˜ ë¹ˆë„ ì œí•œ
   â”œâ”€ ìŠ¬ë¦¬í”¼ì§€ ê²€ì‚¬
   â””â”€ íšŒë¡œì°¨ë‹¨ê¸°

4. ì£¼ë¬¸ ì‹¤í–‰
   â”œâ”€ ë§¤ìˆ˜ ì£¼ë¬¸ (buy_exchange)
   â”œâ”€ ë§¤ë„ ì£¼ë¬¸ (sell_exchange)
   â””â”€ ì‹¤í–‰ ê²°ê³¼ ì €ì¥

5. í¬ì§€ì…˜ ê´€ë¦¬
   â”œâ”€ í¬ì§€ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
   â”œâ”€ ì†ì ˆ/ìµì ˆ ë¡œì§
   â””â”€ í¬ì§€ì…˜ ì •ë¦¬

6. ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
   â”œâ”€ ì”ì•¡, í¬ì§€ì…˜, ì£¼ë¬¸ ìˆ˜
   â”œâ”€ ì†ì‹¤, ê±°ë˜ ìˆ˜
   â””â”€ í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡
```

---

## ğŸ” D15 ëª¨ë“ˆ ì—°ë™

### ë³€ë™ì„± ëª¨ë¸ (VolatilityPredictor)

```python
# í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°
volatility = volatility_predictor.predict_batch(recent_prices)
position_size = calculate_position_size(volatility, total_balance)
```

### í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” (PortfolioOptimizer)

```python
# ë…¸ì¶œë„ ì¡°ì ˆ
returns = portfolio_optimizer.add_returns_batch(symbol_returns)
weights = portfolio_optimizer.get_optimal_weights(symbols)
adjusted_position = position_size * weights[symbol]
```

### ì •ëŸ‰ ë¦¬ìŠ¤í¬ (QuantitativeRiskManager)

```python
# ì†ì‹¤ ì œí•œ
risk_metrics = risk_manager.calculate_risk_metrics(returns)
max_loss = total_balance * risk_metrics.var_95
if current_loss > max_loss:
    circuit_breaker_activated()
```

---

## ğŸ›¡ï¸ ì•ˆì „ ì¥ì¹˜ (LiveGuard)

### í¬ì§€ì…˜ í¬ê¸° ì œí•œ

```
max_position_size = 1,000,000 KRW
```

### ì¼ì¼ ì†ì‹¤ ì œí•œ

```
max_daily_loss = 500,000 KRW
```

### ê±°ë˜ ë¹ˆë„ ì œí•œ

```
max_trades_per_hour = 100
max_trades_per_day = 1,000
```

### íšŒë¡œì°¨ë‹¨ê¸°

```
circuit_breaker_threshold = 5% (ì†ì‹¤ë¥ )
circuit_breaker_cooldown = 300ì´ˆ
```

---

## ğŸ“Š Redis ë°ì´í„° ìŠ¤í‚¤ë§ˆ

### ê°€ê²© (TTL: 60ì´ˆ)

```
arbitrage:prices:{exchange}:{symbol}
  - bid: float
  - ask: float
  - mid: float
  - timestamp: ISO8601
```

### ì‹ í˜¸ (TTL: 300ì´ˆ)

```
arbitrage:signal:{symbol}
  - symbol: str
  - buy_exchange: str
  - sell_exchange: str
  - buy_price: float
  - sell_price: float
  - spread: float
  - spread_pct: float
  - timestamp: ISO8601
```

### ì£¼ë¬¸ (TTL: 86400ì´ˆ)

```
arbitrage:orders:{order_id}
  - order_id: str
  - exchange: str
  - symbol: str
  - side: str (buy/sell)
  - quantity: float
  - price: float
  - status: str
  - filled_quantity: float
  - fill_rate: float
  - created_at: ISO8601
  - updated_at: ISO8601
```

### í¬ì§€ì…˜ (TTL: 86400ì´ˆ)

```
arbitrage:positions:{symbol}
  - symbol: str
  - quantity: float
  - entry_price: float
  - current_price: float
  - side: str (buy/sell)
  - pnl: float
  - pnl_pct: float
  - timestamp: ISO8601
```

### ì‹¤í–‰ ê²°ê³¼ (TTL: 86400ì´ˆ)

```
arbitrage:execution:{symbol}:{timestamp}
  - symbol: str
  - buy_order_id: str
  - sell_order_id: str
  - buy_price: float
  - sell_price: float
  - quantity: float
  - gross_pnl: float
  - net_pnl: float
  - fees: float
  - pnl_pct: float
  - timestamp: ISO8601
```

### ë©”íŠ¸ë¦­ (TTL: 300ì´ˆ)

```
arbitrage:metrics:live
  - total_balance: float
  - available_balance: float
  - positions_count: int
  - orders_count: int
  - daily_loss: float
  - total_loss: float
  - trades_today: int
```

### í•˜íŠ¸ë¹„íŠ¸ (TTL: 60ì´ˆ)

```
arbitrage:heartbeat:{component}
  - timestamp: ISO8601
```

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

### í—¬ìŠ¤ ì²´í¬

```
GET /health
```

### ë©”íŠ¸ë¦­

```
GET /metrics/live
```

### í¬ì§€ì…˜

```
GET /positions
GET /positions/{symbol}
```

### ì‹ í˜¸

```
GET /signals
GET /signals/{symbol}
```

### ì£¼ë¬¸

```
GET /orders
GET /orders/{order_id}
```

### ì‹¤í–‰ ê²°ê³¼

```
GET /executions?symbol={symbol}&limit={limit}
```

### WebSocket

```
WS /ws/metrics
WS /ws/signals
```

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. í™˜ê²½ ì„¤ì •

```bash
# .env íŒŒì¼ ìƒì„±
cp infra/.env.example infra/.env

# í¸ì§‘
UPBIT_API_KEY=your_key
UPBIT_SECRET_KEY=your_secret
BINANCE_API_KEY=your_key
BINANCE_SECRET_KEY=your_secret
LIVE_MODE=false  # paper mode
```

### 2. Docker Compose ì‹¤í–‰

```bash
cd infra
docker-compose up -d
```

### 3. ì‹¤ê±°ë˜ ë£¨í”„ ì‹œì‘

```bash
python -m arbitrage.live_trader
```

### 4. API ì„œë²„ ì‹œì‘

```bash
python -m api.server
```

### 5. ëŒ€ì‹œë³´ë“œ ì ‘ì†

```
http://localhost:8001
```

---

## ğŸ“ˆ ì„±ëŠ¥ ëª©í‘œ

| í•­ëª© | ëª©í‘œ |
|------|------|
| ê°€ê²© ìˆ˜ì§‘ ì§€ì—° | < 100ms |
| ì‹ í˜¸ ìƒì„± ì§€ì—° | < 50ms |
| ì£¼ë¬¸ ì‹¤í–‰ ì§€ì—° | < 500ms |
| ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸ | 1ì´ˆ |
| API ì‘ë‹µ ì‹œê°„ | < 100ms |

---

## ğŸ”— ì°¸ê³  ë¬¸ì„œ

- `docs/ROLE.md` - í”„ë¡œì íŠ¸ ê·œì¹™
- `docs/D16_LIVE_API.md` - API ìƒì„¸ ë¬¸ì„œ
- `docs/D16_LIVE_TRADING_LOOP.md` - ê±°ë˜ ë£¨í”„ ìƒì„¸
- `docs/D16_REDIS_SCHEMA.md` - Redis ìŠ¤í‚¤ë§ˆ ìƒì„¸
